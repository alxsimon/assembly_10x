BootStrap: docker
From: ubuntu:18.04

%labels
	Author Alexis Simon
	Version v0.0.1

%environment
	export PATH=/opt/conda/bin:$PATH
    export LC_ALL=C.UTF-8
	export LANG=C.UTF-8
	export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig/

%post
	apt-get update && apt-get upgrade -y
	export DEBIAN_FRONTEND=noninteractive
	apt-get install -y tzdata
	TZ=Europe/Paris
	ln -snf /usr/share/zoneinfo/$TZ /etc/localtime
	echo $TZ > /etc/timezone
	dpkg-reconfigure --frontend noninteractive tzdata
	apt-get install -y \
		apt-utils \
		pkg-config \
		wget \
		git \
		build-essential \
		automake \
		curl \
		bzip2 \
		software-properties-common \
		ca-certificates \
		libcurl4-openssl-dev \
		libssh2-1-dev \
		libzip-dev \
		zlib1g-dev \
		libicu-dev

    ### Install R ###
	apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
	add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu bionic-cran35/'
	apt-get update && apt-get -y install r-base r-base-dev r-recommended

	Rscript -e 'install.packages(c("stringi", "stringr"), clean=TRUE)'

    ### Install Conda ###
	curl -sSL https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -o /tmp/miniconda.sh \
	&& bash /tmp/miniconda.sh -bp /opt/conda \
	&& export PATH=/opt/conda/bin:$PATH \
	&& conda update -y conda \
	&& conda clean --all --yes
	cp /opt/conda/etc/profile.d/conda.sh /conda_init.sh
	sed -i 's/\$PS1/\$\{PS1:-\}/g' /conda_init.sh

	conda config --add channels defaults
	conda config --add channels bioconda
	conda config --add channels conda-forge

	conda install -y numpy scipy pandas snakemake

    ## Install Bioinfo tools ##
	conda install -c bioconda -y \
		samtools \
		fastqc \
		bwa \
		minimap2 \
        jellyfish

	## Custom KMC fork ##
	git clone https://github.com/tbenavi1/KMC.git /opt/KMC
	cd /opt/KMC
	make
	ln -s /opt/KMC/bin/* -t /usr/local/bin/

    ## Proc10x ##
    git clone https://github.com/ucdavis-bioinformatics/proc10xG.git /opt/proc10xG

    ## Genomescope 2.0 and Smudgeplot ##
    Rscript -e 'install.packages(c("minpack.lm", "argparse", "viridis", "devtools"), clean=TRUE)'
	git clone https://github.com/tbenavi1/genomescope2.0.git /opt/genomescope2.0
	cd /opt/genomescope2.0
	Rscript -e 'install.packages(".", repos=NULL, type="source")'

	git clone https://github.com/KamilSJaron/smudgeplot /opt/smudgeplot
	cd /opt/smudgeplot
	Rscript install.R
	install -C exec/smudgeplot.py /usr/local/bin
	install -C exec/smudgeplot_plot.R /usr/local/bin

	## Platanus-allee ##
	wget http://platanus.bio.titech.ac.jp/?ddownload=431 -O /tmp/platanus_allee.tgz
	cd /opt/
	tar -xvzf /tmp/platanus_allee.tgz && rm /tmp/platanus_allee.tgz
	ln -s /opt/Platanus_allee_*/platanus_allee -t /usr/local/bin/

%apprun run
	exec /bin/bash "$@"

%runscript
	exec /bin/bash "$@"

